name: Daily Content Posting

on:
  schedule:
    # 12:00 PM Central Time = 6:00 PM UTC (CST) or 5:00 PM UTC (CDT)
    # Using 6 PM UTC for Central Standard Time
    - cron: '0 18 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  trigger-posting:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Daily Content Generation & Posting
        id: trigger
        run: |
          echo "ğŸš€ Triggering daily content posting at $(date)"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.RAILWAY_URL }}/api/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 120)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          # Check if HTTP request was successful
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… API call successful!"

            # Parse posting results - count successes
            SUCCESS_COUNT=$(echo "$BODY" | grep -o '"success":true' | wc -l)
            TOTAL_PLATFORMS=5

            echo "ğŸ“Š Platforms posted: $SUCCESS_COUNT / $TOTAL_PLATFORMS"

            # Consider success if at least 2 platforms succeeded (LinkedIn, Blogger, Tumblr typically work)
            if [ "$SUCCESS_COUNT" -ge 2 ]; then
              echo "âœ… Daily posting completed successfully ($SUCCESS_COUNT platforms)"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Only $SUCCESS_COUNT platforms succeeded"
              echo "success=partial" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Failed to trigger daily posting (HTTP $HTTP_CODE)"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Log Result
        if: always()
        run: |
          echo "ğŸ“Š Daily posting workflow completed at $(date)"
          echo ""
          echo "ğŸ”— Check your social media accounts for new posts:"
          echo "  âœ“ LinkedIn: https://www.linkedin.com/in/isaac-accelerating"
          echo "  âœ“ Blogger: https://acceleratingsuccess25.blogspot.com"
          echo "  âœ“ Tumblr: https://acceleratingsuccess.tumblr.com"
          echo "  âš ï¸ Twitter: Rate limited on Free tier (1 post/day max)"
          echo "  âš ï¸ Facebook: Credentials not configured"
